Object.defineProperty(exports,"__esModule",{value:true});exports.SalesforceApiRequest=exports.STORAGE_EXPIRE_SPAN=exports.STORAGE_KEY=undefined;var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();









var _reactNative=require('react-native');function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}var HTTP_UNAUTHORIZED=401;var STORAGE_KEY=exports.STORAGE_KEY='@SalesforceApiRequest:Credentials';var STORAGE_EXPIRE_SPAN=exports.STORAGE_EXPIRE_SPAN=1000*60*60*24;var OAUTH_REFRESH_TOKEN_GRANT_TYPE='refresh_token';var OAUTH_SALESFORCE_LOGIN_URL='https://login.salesforce.com/services/oauth2/token';var

SalesforceApiRequest=exports.SalesforceApiRequest=function(){

function SalesforceApiRequest(nativeMethods){_classCallCheck(this,SalesforceApiRequest);
this.nativeMethods=nativeMethods;
}_createClass(SalesforceApiRequest,[{key:'isLoggedIn',value:function isLoggedIn(){var credentials;return regeneratorRuntime.async(function isLoggedIn$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.next=2;return regeneratorRuntime.awrap(


this.getStoredCredentials());case 2:credentials=_context.sent;return _context.abrupt('return',
credentials!=null);case 4:case'end':return _context.stop();}}},null,this);}},{key:'logOut',value:function logOut(){return regeneratorRuntime.async(function logOut$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.next=2;return regeneratorRuntime.awrap(



_reactNative.AsyncStorage.removeItem(STORAGE_KEY));case 2:_context2.next=4;return regeneratorRuntime.awrap(
this.nativeMethods.logout());case 4:case'end':return _context2.stop();}}},null,this);}},{key:'getCredentials',value:function getCredentials(


parameters){var credentials;return regeneratorRuntime.async(function getCredentials$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:_context3.next=2;return regeneratorRuntime.awrap(
this.getStoredCredentials());case 2:credentials=_context3.sent;if(!

credentials){_context3.next=5;break;}return _context3.abrupt('return',
credentials);case 5:_context3.next=7;return regeneratorRuntime.awrap(


this.nativeMethods.loginUser(parameters));case 7:credentials=_context3.sent;_context3.next=10;return regeneratorRuntime.awrap(
this.setCredentials(credentials));case 10:return _context3.abrupt('return',
credentials);case 11:case'end':return _context3.stop();}}},null,this);}},{key:'getStoredCredentials',value:function getStoredCredentials(


parameters){var credentials;return regeneratorRuntime.async(function getStoredCredentials$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:_context4.prev=0;_context4.t0=

JSON;_context4.next=4;return regeneratorRuntime.awrap(_reactNative.AsyncStorage.getItem(STORAGE_KEY));case 4:_context4.t1=_context4.sent;credentials=_context4.t0.parse.call(_context4.t0,_context4.t1);if(!(

Date.now()-credentials.issued_at>STORAGE_EXPIRE_SPAN)){_context4.next=8;break;}throw(
new Error('Storage key expired'));case 8:return _context4.abrupt('return',


credentials);case 11:_context4.prev=11;_context4.t2=_context4['catch'](0);_context4.next=15;return regeneratorRuntime.awrap(


this.logOut());case 15:return _context4.abrupt('return',

null);case 16:case'end':return _context4.stop();}}},null,this,[[0,11]]);}},{key:'setCredentials',value:function setCredentials(


credentials){return regeneratorRuntime.async(function setCredentials$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:_context5.next=2;return regeneratorRuntime.awrap(
_reactNative.AsyncStorage.setItem(STORAGE_KEY,JSON.stringify(credentials)));case 2:case'end':return _context5.stop();}}},null,this);}},{key:'post',value:function post(


parameters,url,body){var fetchAction;return regeneratorRuntime.async(function post$(_context6){while(1){switch(_context6.prev=_context6.next){case 0:
fetchAction=function fetchAction(cred){return fetch(cred.instance_url+'/services/apexrest/'+parameters.namespace+url,{
method:'post',
headers:{
'Authorization':'Bearer '+cred.access_token,
'Content-Type':'application/json',
'Accept':'application/json'},

body:JSON.stringify(body)});};_context6.next=3;return regeneratorRuntime.awrap(


this.apiCall(fetchAction,parameters,url));case 3:return _context6.abrupt('return',_context6.sent);case 4:case'end':return _context6.stop();}}},null,this);}},{key:'apiCall',value:function apiCall(


fetchAction,parameters,url){var _this=this;var credentials,processResponse,response,newCredentials;return regeneratorRuntime.async(function apiCall$(_context8){while(1){switch(_context8.prev=_context8.next){case 0:_context8.next=2;return regeneratorRuntime.awrap(
this.getCredentials(parameters));case 2:credentials=_context8.sent;

processResponse=function processResponse(response){return regeneratorRuntime.async(function processResponse$(_context7){while(1){switch(_context7.prev=_context7.next){case 0:if(!
response.ok){_context7.next=7;break;}_context7.next=3;return regeneratorRuntime.awrap(

response.json());case 3:_context7.t0=_context7.sent;_context7.t1=
response.status;_context7.t2=
response;return _context7.abrupt('return',{json:_context7.t0,status:_context7.t1,response:_context7.t2});case 7:throw(


response);case 8:case'end':return _context7.stop();}}},null,_this);};_context8.next=6;return regeneratorRuntime.awrap(


fetchAction(credentials));case 6:response=_context8.sent;if(!(

response.status===HTTP_UNAUTHORIZED)){_context8.next=14;break;}_context8.next=10;return regeneratorRuntime.awrap(
this.refreshToken(parameters,credentials));case 10:newCredentials=_context8.sent;_context8.next=13;return regeneratorRuntime.awrap(

fetchAction(newCredentials).then(processResponse));case 13:return _context8.abrupt('return',_context8.sent);case 14:return _context8.abrupt('return',


processResponse(response));case 15:case'end':return _context8.stop();}}},null,this);}},{key:'refreshToken',value:function refreshToken(


parameters,credentials){var refreshParams,form,response,newCredentials;return regeneratorRuntime.async(function refreshToken$(_context9){while(1){switch(_context9.prev=_context9.next){case 0:_context9.next=2;return regeneratorRuntime.awrap(


this.logOut());case 2:

refreshParams={
grant_type:OAUTH_REFRESH_TOKEN_GRANT_TYPE,
refresh_token:credentials.refresh_token,
client_id:parameters.consumerKey,
client_secret:parameters.consumerSecret};

form=Object.keys(refreshParams).map(function(k){return k+'='+encodeURIComponent(refreshParams[k]);}).join('&');_context9.next=6;return regeneratorRuntime.awrap(

fetch(OAUTH_SALESFORCE_LOGIN_URL,{
credentials:'include',
method:'post',
headers:{
'Authorization':'Bearer '+credentials.access_token,
'Accept':'application/json',
'Content-Type':'application/x-www-form-urlencoded; charset=utf-8'},

body:form}));case 6:response=_context9.sent;if(


response.ok){_context9.next=9;break;}throw(
response);case 9:_context9.next=11;return regeneratorRuntime.awrap(


response.json());case 11:newCredentials=_context9.sent;

credentials.access_token=newCredentials.access_token;_context9.next=15;return regeneratorRuntime.awrap(

this.setCredentials(credentials));case 15:return _context9.abrupt('return',

credentials);case 16:case'end':return _context9.stop();}}},null,this);}}]);return SalesforceApiRequest;}();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NhbGVzZm9yY2VBcGlSZXF1ZXN0LmpzIl0sIm5hbWVzIjpbIkhUVFBfVU5BVVRIT1JJWkVEIiwiU1RPUkFHRV9LRVkiLCJTVE9SQUdFX0VYUElSRV9TUEFOIiwiT0FVVEhfUkVGUkVTSF9UT0tFTl9HUkFOVF9UWVBFIiwiT0FVVEhfU0FMRVNGT1JDRV9MT0dJTl9VUkwiLCJTYWxlc2ZvcmNlQXBpUmVxdWVzdCIsIm5hdGl2ZU1ldGhvZHMiLCJnZXRTdG9yZWRDcmVkZW50aWFscyIsImNyZWRlbnRpYWxzIiwicmVtb3ZlSXRlbSIsImxvZ291dCIsInBhcmFtZXRlcnMiLCJsb2dpblVzZXIiLCJzZXRDcmVkZW50aWFscyIsIkpTT04iLCJnZXRJdGVtIiwicGFyc2UiLCJEYXRlIiwibm93IiwiaXNzdWVkX2F0IiwiRXJyb3IiLCJsb2dPdXQiLCJzZXRJdGVtIiwic3RyaW5naWZ5IiwidXJsIiwiYm9keSIsImZldGNoQWN0aW9uIiwiY3JlZCIsImZldGNoIiwiaW5zdGFuY2VfdXJsIiwibmFtZXNwYWNlIiwibWV0aG9kIiwiaGVhZGVycyIsImFjY2Vzc190b2tlbiIsImFwaUNhbGwiLCJnZXRDcmVkZW50aWFscyIsInByb2Nlc3NSZXNwb25zZSIsInJlc3BvbnNlIiwib2siLCJqc29uIiwic3RhdHVzIiwicmVmcmVzaFRva2VuIiwibmV3Q3JlZGVudGlhbHMiLCJ0aGVuIiwicmVmcmVzaFBhcmFtcyIsImdyYW50X3R5cGUiLCJyZWZyZXNoX3Rva2VuIiwiY2xpZW50X2lkIiwiY29uc3VtZXJLZXkiLCJjbGllbnRfc2VjcmV0IiwiY29uc3VtZXJTZWNyZXQiLCJmb3JtIiwiT2JqZWN0Iiwia2V5cyIsIm1hcCIsImsiLCJlbmNvZGVVUklDb21wb25lbnQiLCJqb2luIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7O0FBVUEseUMsaUpBVkEsR0FBTUEsbUJBQW9CLEdBQTFCLENBRU8sR0FBTUMsaUNBQWMsbUNBQXBCLENBRUEsR0FBTUMsaURBQXNCLEtBQU8sRUFB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QUdyREMsUUFBUztBQUNMLDBCQUEyQnhCLFlBQVl5QixZQURsQztBQUVMLFNBQVUsa0JBRkw7QUFHTCxlQUFnQixrREFIWCxDQUg0Qzs7QUFRckRSLEtBQU0wQixJQVIrQyxDQUFsQyxDLFNBQWpCZCxROzs7QUFXREEsU0FBU0MsRTtBQUNKRCxROzs7QUFHbUJBLFNBQVNFLElBQVQsRSxVQUF2QkcsYzs7QUFFTmxDLFlBQVl5QixZQUFaLENBQTJCUyxlQUFlVCxZQUExQyxDOztBQUVNLEtBQUtwQixjQUFMLENBQW9CTCxXQUFwQixDOztBQUVDQSxXIiwiZmlsZSI6InNhbGVzZm9yY2VBcGlSZXF1ZXN0LmpzIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgSFRUUF9VTkFVVEhPUklaRUQgPSA0MDFcblxuZXhwb3J0IGNvbnN0IFNUT1JBR0VfS0VZID0gJ0BTYWxlc2ZvcmNlQXBpUmVxdWVzdDpDcmVkZW50aWFscydcblxuZXhwb3J0IGNvbnN0IFNUT1JBR0VfRVhQSVJFX1NQQU4gPSAxMDAwICogNjAgKiA2MCAqIDI0XG5cbmNvbnN0IE9BVVRIX1JFRlJFU0hfVE9LRU5fR1JBTlRfVFlQRSA9ICdyZWZyZXNoX3Rva2VuJ1xuY29uc3QgT0FVVEhfU0FMRVNGT1JDRV9MT0dJTl9VUkwgPSAnaHR0cHM6Ly9sb2dpbi5zYWxlc2ZvcmNlLmNvbS9zZXJ2aWNlcy9vYXV0aDIvdG9rZW4nXG5cblxuaW1wb3J0IHsgQXN5bmNTdG9yYWdlIH0gZnJvbSAncmVhY3QtbmF0aXZlJ1xuIFxuZXhwb3J0IGNsYXNzIFNhbGVzZm9yY2VBcGlSZXF1ZXN0IHtcblxuXHRjb25zdHJ1Y3RvcihuYXRpdmVNZXRob2RzKSB7XG5cdFx0dGhpcy5uYXRpdmVNZXRob2RzID0gbmF0aXZlTWV0aG9kcztcblx0fVxuXG4gICAgYXN5bmMgaXNMb2dnZWRJbigpIHtcbiAgICAgICAgbGV0IGNyZWRlbnRpYWxzID0gYXdhaXQgdGhpcy5nZXRTdG9yZWRDcmVkZW50aWFscygpO1xuICAgICAgICByZXR1cm4gY3JlZGVudGlhbHMgIT0gbnVsbDtcbiAgICB9XG5cbiAgICBhc3luYyBsb2dPdXQoKSB7XG4gICAgICAgIGF3YWl0IEFzeW5jU3RvcmFnZS5yZW1vdmVJdGVtKFNUT1JBR0VfS0VZKVxuICAgICAgICBhd2FpdCB0aGlzLm5hdGl2ZU1ldGhvZHMubG9nb3V0KClcbiAgICB9XG5cbiAgICBhc3luYyBnZXRDcmVkZW50aWFscyhwYXJhbWV0ZXJzKSB7XG4gICAgICAgIGxldCBjcmVkZW50aWFscyA9IGF3YWl0IHRoaXMuZ2V0U3RvcmVkQ3JlZGVudGlhbHMoKTtcbiAgICAgICAgXG4gICAgICAgIGlmIChjcmVkZW50aWFscykge1xuICAgICAgICAgICAgcmV0dXJuIGNyZWRlbnRpYWxzO1xuICAgICAgICB9XG5cbiAgICAgICAgY3JlZGVudGlhbHMgPSBhd2FpdCB0aGlzLm5hdGl2ZU1ldGhvZHMubG9naW5Vc2VyKHBhcmFtZXRlcnMpO1xuICAgICAgICBhd2FpdCB0aGlzLnNldENyZWRlbnRpYWxzKGNyZWRlbnRpYWxzKTtcbiAgICAgICAgcmV0dXJuIGNyZWRlbnRpYWxzO1xuICAgIH1cblxuICAgIGFzeW5jIGdldFN0b3JlZENyZWRlbnRpYWxzKHBhcmFtZXRlcnMpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IGNyZWRlbnRpYWxzID0gSlNPTi5wYXJzZShhd2FpdCBBc3luY1N0b3JhZ2UuZ2V0SXRlbShTVE9SQUdFX0tFWSkpO1xuXG4gICAgICAgICAgICBpZiAoRGF0ZS5ub3coKSAtIGNyZWRlbnRpYWxzLmlzc3VlZF9hdCA+IFNUT1JBR0VfRVhQSVJFX1NQQU4pIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1N0b3JhZ2Uga2V5IGV4cGlyZWQnKVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4gY3JlZGVudGlhbHM7XG4gICAgICAgIH1cbiAgICAgICAgY2F0Y2goZXJyb3IpIHtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMubG9nT3V0KCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICAgIFxuICAgIGFzeW5jIHNldENyZWRlbnRpYWxzKGNyZWRlbnRpYWxzKSB7XG4gICAgICAgIGF3YWl0IEFzeW5jU3RvcmFnZS5zZXRJdGVtKFNUT1JBR0VfS0VZLCBKU09OLnN0cmluZ2lmeShjcmVkZW50aWFscykpXG4gICAgfVxuXG5cdGFzeW5jIHBvc3QocGFyYW1ldGVycywgdXJsLCBib2R5KSB7XG4gICAgICAgIGNvbnN0IGZldGNoQWN0aW9uID0gKGNyZWQpID0+IGZldGNoKGAke2NyZWQuaW5zdGFuY2VfdXJsfS9zZXJ2aWNlcy9hcGV4cmVzdC8ke3BhcmFtZXRlcnMubmFtZXNwYWNlfSR7dXJsfWAsIHtcbiAgICAgICAgICAgIG1ldGhvZDogJ3Bvc3QnLCBcbiAgICAgICAgICAgICAgICBoZWFkZXJzOiB7XG4gICAgICAgICAgICAgICAgICAgICdBdXRob3JpemF0aW9uJzogYEJlYXJlciAke2NyZWQuYWNjZXNzX3Rva2VufWAsIFxuICAgICAgICAgICAgICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLFxuICAgICAgICAgICAgICAgICAgICAnQWNjZXB0JzogJ2FwcGxpY2F0aW9uL2pzb24nXG4gICAgICAgICAgICAgICAgfSwgXG4gICAgICAgICAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoYm9keSlcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiBhd2FpdCB0aGlzLmFwaUNhbGwoZmV0Y2hBY3Rpb24sIHBhcmFtZXRlcnMsIHVybClcbiAgICB9XG5cbiAgICBhc3luYyBhcGlDYWxsKGZldGNoQWN0aW9uLCBwYXJhbWV0ZXJzLCB1cmwpIHtcblx0XHRjb25zdCBjcmVkZW50aWFscyA9IGF3YWl0IHRoaXMuZ2V0Q3JlZGVudGlhbHMocGFyYW1ldGVycyk7XG5cbiAgICAgICAgY29uc3QgcHJvY2Vzc1Jlc3BvbnNlID0gYXN5bmMgKHJlc3BvbnNlKSA9PiB7XG4gICAgICAgICAgICBpZiAocmVzcG9uc2Uub2spIHtcbiAgICAgICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgICAgICBqc29uOiBhd2FpdCByZXNwb25zZS5qc29uKCksXG4gICAgICAgICAgICAgICAgICAgIHN0YXR1czogcmVzcG9uc2Uuc3RhdHVzLFxuICAgICAgICAgICAgICAgICAgICByZXNwb25zZTogcmVzcG9uc2VcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhyb3cgcmVzcG9uc2U7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGZldGNoQWN0aW9uKGNyZWRlbnRpYWxzKTtcblxuICAgICAgICBpZiAocmVzcG9uc2Uuc3RhdHVzID09PSBIVFRQX1VOQVVUSE9SSVpFRCkge1xuICAgICAgICAgICAgY29uc3QgbmV3Q3JlZGVudGlhbHMgPSBhd2FpdCB0aGlzLnJlZnJlc2hUb2tlbihwYXJhbWV0ZXJzLCBjcmVkZW50aWFscylcblxuICAgICAgICAgICAgcmV0dXJuIGF3YWl0IGZldGNoQWN0aW9uKG5ld0NyZWRlbnRpYWxzKS50aGVuKHByb2Nlc3NSZXNwb25zZSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gcHJvY2Vzc1Jlc3BvbnNlKHJlc3BvbnNlKVxuXHR9XG5cbiAgICBhc3luYyByZWZyZXNoVG9rZW4ocGFyYW1ldGVycywgY3JlZGVudGlhbHMpIHtcbiAgICAgICAgLy8gUmVtb3ZlIGV4cGlyZWQgY3JlZGVudGlhbHMuIEluIGNhc2Ugb2Ygc3VjY2VzcyByZWZyZXNoIG5ldyBjcmVkZW50aWFscyB3aWxsIGJlIHN0b3JlZFxuICAgICAgICAvLyBJbiBjYXNlIG9mIGVycm9yIG5leHQgY2FsbCB0byB0aGUgQVBJIHdpbGwgZm9yY2UgbG9naW4gc2NyZWVuIHRvIGFwcGVhclxuICAgICAgICBhd2FpdCB0aGlzLmxvZ091dCgpO1xuXG4gICAgICAgIGNvbnN0IHJlZnJlc2hQYXJhbXMgPSB7XG4gICAgICAgICAgICBncmFudF90eXBlOiBPQVVUSF9SRUZSRVNIX1RPS0VOX0dSQU5UX1RZUEUsXG4gICAgICAgICAgICByZWZyZXNoX3Rva2VuOiBjcmVkZW50aWFscy5yZWZyZXNoX3Rva2VuLFxuICAgICAgICAgICAgY2xpZW50X2lkOiBwYXJhbWV0ZXJzLmNvbnN1bWVyS2V5LFxuICAgICAgICAgICAgY2xpZW50X3NlY3JldDogcGFyYW1ldGVycy5jb25zdW1lclNlY3JldFxuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGZvcm0gPSBPYmplY3Qua2V5cyhyZWZyZXNoUGFyYW1zKS5tYXAoKGspPT4gYCR7a309JHtlbmNvZGVVUklDb21wb25lbnQocmVmcmVzaFBhcmFtc1trXSl9YCkuam9pbignJicpO1xuICAgICAgICBcbiAgICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaChPQVVUSF9TQUxFU0ZPUkNFX0xPR0lOX1VSTCwge1xuICAgICAgICAgICAgY3JlZGVudGlhbHM6ICdpbmNsdWRlJyxcbiAgICAgICAgICAgIG1ldGhvZDogJ3Bvc3QnLFxuICAgICAgICAgICAgaGVhZGVyczoge1xuICAgICAgICAgICAgICAgICdBdXRob3JpemF0aW9uJzogYEJlYXJlciAke2NyZWRlbnRpYWxzLmFjY2Vzc190b2tlbn1gLCBcbiAgICAgICAgICAgICAgICAnQWNjZXB0JzogJ2FwcGxpY2F0aW9uL2pzb24nLFxuICAgICAgICAgICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkOyBjaGFyc2V0PXV0Zi04J1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGJvZHk6IGZvcm1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgaWYgKCFyZXNwb25zZS5vaykge1xuICAgICAgICAgICAgdGhyb3cgcmVzcG9uc2VcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IG5ld0NyZWRlbnRpYWxzID0gYXdhaXQgcmVzcG9uc2UuanNvbigpXG5cbiAgICAgICAgY3JlZGVudGlhbHMuYWNjZXNzX3Rva2VuID0gbmV3Q3JlZGVudGlhbHMuYWNjZXNzX3Rva2VuO1xuXG4gICAgICAgIGF3YWl0IHRoaXMuc2V0Q3JlZGVudGlhbHMoY3JlZGVudGlhbHMpO1xuXG4gICAgICAgIHJldHVybiBjcmVkZW50aWFscztcbiAgICB9XG59Il19